<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="user-list">
            <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
            <button id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            <button id="dark-mode-toggle">ðŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
            <ul id="user-list"></ul>
        </div>
        <div class="chat-box">
            <h3 id="chat-title">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
            <p id="typing-status"></p>
            <div id="messages"></div>
            <div class="input-box">
                <input type="text" id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." oninput="showTyping()">
                <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getDatabase, ref, onChildAdded, push, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

        // ðŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Firebase (Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§)
        const firebaseConfig = { /* Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù‡Ù†Ø§ */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser;
        let selectedUser = null;

        // ðŸ”¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loadUsers();
            } else {
                window.location.href = "index.html";
            }
        });

        // ðŸ”¹ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function loadUsers() {
            get(ref(db, "users")).then(snapshot => {
                if (snapshot.exists()) {
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = "";
                    Object.entries(snapshot.val()).forEach(([uid, userData]) => {
                        if (uid !== currentUser.uid) {
                            const li = document.createElement('li');
                            li.textContent = userData.username;
                            li.addEventListener("click", () => startChat(uid, userData.username));
                            userList.appendChild(li);
                        }
                    });
                }
            });
        }

        // ðŸ”¹ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ÙŠÙ†
        function startChat(userId, username) {
            selectedUser = userId;
            document.getElementById("chat-title").textContent = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ " + username;
            document.getElementById("messages").innerHTML = "";

            const chatId = [currentUser.uid, selectedUser].sort().join("_");
            const messagesRef = ref(db, "chats/" + chatId);

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
            onChildAdded(messagesRef, snapshot => {
                const messageData = snapshot.val();
                const messageDiv = document.createElement("div");
                messageDiv.className = "message " + (messageData.sender === currentUser.uid ? "you" : "other");
                messageDiv.textContent = messageData.text;
                document.getElementById("messages").appendChild(messageDiv);
                playNotificationSound();
            });

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
            onValue(ref(db, `typing/${selectedUser}`), snapshot => {
                if (snapshot.exists() && snapshot.val().typing) {
                    document.getElementById("typing-status").textContent = username + " ÙŠÙƒØªØ¨...";
                } else {
                    document.getElementById("typing-status").textContent = "";
                }
            });
        }

        // ðŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        document.getElementById("send-btn").addEventListener("click", () => {
            const messageInput = document.getElementById("message");
            if (messageInput.value.trim() && selectedUser) {
                const chatId = [currentUser.uid, selectedUser].sort().join("_");
                push(ref(db, "chats/" + chatId), {
                    sender: currentUser.uid,
                    text: messageInput.value
                });
                messageInput.value = "";
                set(ref(db, `typing/${currentUser.uid}`), { typing: false });
            }
        });

        // ðŸ”¹ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        let typingTimeout;
        function showTyping() {
            set(ref(db, `typing/${currentUser.uid}`), { typing: true });

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(ref(db, `typing/${currentUser.uid}`), { typing: false });
            }, 2000);
        }

        // ðŸ”¹ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        function playNotificationSound() {
            let sound = new Audio("notification.mp3");
            sound.play();
        }

      // âœ… ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
document.getElementById("dark-mode-toggle").addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
});

// âœ… ØªÙØ¹ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logout-btn").addEventListener("click", () => {
    import("https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js")
        .then(({ getAuth, signOut }) => {
            const auth = getAuth();
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });
});

// âœ… ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
document.getElementById("send-btn").addEventListener("click", sendMessage);

document.getElementById("message").addEventListener("keypress", function (event) {
    if (event.key === "Enter") sendMessage();
});

function sendMessage() {
    const messageInput = document.getElementById("message");
    if (messageInput.value.trim() && selectedUser) {
        import("https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js")
            .then(({ getDatabase, ref, push }) => {
                const db = getDatabase();
                const chatId = [currentUser.uid, selectedUser].sort().join("_");

                push(ref(db, "chats/" + chatId), {
                    sender: currentUser.uid,
                    text: messageInput.value
                });

                messageInput.value = "";
            });
    }
}

    </script>
</body>
</html>
