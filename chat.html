<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="user-list">
            <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
            <ul id="user-list"></ul>
            <button id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            <button id="dark-mode-toggle">ðŸŒ™ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ</button>
        </div>
        <div class="chat-box">
            <h3 id="chat-title">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
            <div id="messages"></div>
            <div class="input-box">
                <input type="text" id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." oninput="showTyping()">
                <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getDatabase, ref, onChildAdded, push, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

        // ØªÙƒÙˆÙŠÙ† Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHvY3ioMroA0YGMySyjBAjQPx7M3z8HPA",
            authDomain: "chat-dddf0.firebaseapp.com",
            databaseURL: "https://chat-dddf0-default-rtdb.firebaseio.com",
            projectId: "chat-dddf0",
            storageBucket: "chat-dddf0.appspot.com",
            messagingSenderId: "777441857226",
            appId: "1:777441857226:web:96bca1f2c29291db906e33",
            measurementId: "G-RMYXYFHFTR"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser;
        let selectedUser = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loadUsers();
            } else {
                window.location.href = "index.html";
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function loadUsers() {
            get(ref(db, "users")).then(snapshot => {
                if (snapshot.exists()) {
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = "";
                    Object.entries(snapshot.val()).forEach(([uid, userData]) => {
                        if (uid !== currentUser.uid) {
                            const li = document.createElement('li');
                            li.textContent = userData.username;
                            li.addEventListener("click", () => startChat(uid, userData.username));
                            userList.appendChild(li);
                        }
                    });
                }
            });
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function startChat(userId, username) {
            selectedUser = userId;
            document.getElementById("chat-title").textContent = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ " + username;
            document.getElementById("messages").innerHTML = "";

            const chatId = [currentUser.uid, selectedUser].sort().join("_");
            const messagesRef = ref(db, "chats/" + chatId);

            onChildAdded(messagesRef, snapshot => {
                const messageData = snapshot.val();
                const messageDiv = document.createElement("div");
                messageDiv.className = "message " + (messageData.sender === currentUser.uid ? "you" : "other");
                messageDiv.textContent = messageData.text;
                document.getElementById("messages").appendChild(messageDiv);
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        document.getElementById("send-btn").addEventListener("click", sendMessage);
        document.getElementById("message").addEventListener("keypress", function (event) {
            if (event.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const messageInput = document.getElementById("message");
            if (messageInput.value.trim() && selectedUser) {
                const chatId = [currentUser.uid, selectedUser].sort().join("_");
                push(ref(db, "chats/" + chatId), {
                    sender: currentUser.uid,
                    text: messageInput.value
                });
                messageInput.value = "";
            }
        }

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById("logout-btn").addEventListener("click", () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        document.getElementById("dark-mode-toggle").addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
        });

        // Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        function showTyping() {
            console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨...");
        }
    </script>
</body>
</html>
